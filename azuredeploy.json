{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "group": "Infrastructure Configuration",
                "description": "The region to deploy the resources into. Only change if resources need to be deployed to a different location than the resource group."
            }
          },
          "vmName": {
            "type": "string",
            "metadata": {
                "group": "Infrastructure Configuration",
                "description": "Specify the name of the VM meeting the Caltex naming standards."
            }
          },
          "vmSize": {
            "type": "string",
            "defaultValue": "Standard_DS2_v2",
            "metadata": {
                "group": "Infrastructure Configuration",
                "description": "Specify the size of the VM required."
            }
          },
          "boolAvSetRequired": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "Whether this server should belong to an Availability Set. Allowed values are true or false"
              }
          },
          "boolAvSetCreateNew": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "Whether a new AV Set should be created. Allowed values are true or false"
              }
          },
          "avSetName": {
            "defaultValue": "None",
            "type": "string",
            "metadata": {
                "description": "Specify the name of the Availability Set, if required. Specify None if not required"
            }
          },
          "vmOsDiskSize": {
            "defaultValue": 128,
            "type": "int",
            "metadata": {
                "description": "The size of the VM OS Disk in GB"
            }
          },
           "osDiskStorageType": {
            "type": "string",
            "defaultValue": "Standard_LRS",
            "metadata": {
                "group": "Infrastructure Configuration",
                "description": "The type of disk storage to use for OS Disk. Accepted values are Standard_LRS, StandardSSD_LRS or Premium_LRS"
              },
              "allowedValues": [
                "Standard_LRS",
                "StandardSSD_LRS",
                "Premium_LRS"
            ]
          },
          "dataDisks": {
            "type": "array",
            "metadata": {
                "description": "The data disks to attach to the VM"
            }
          },
          "networkPrivateOrPublic": {
            "type": "string",
            "defaultValue": "Private",
            "metadata": {
                "group": "Network Configuration",
                "description": "Whether this server should attach a Public IP to the primary NIC or only use a Private IP"
              },
              "allowedValues": [
                "Public",
                "Private"
            ]
          },
          "publicIpAllocationType": {
            "defaultValue": "Dynamic",
            "type": "string",
            "metadata": {
                "description": "Specify whether the public IP should be Static or Dynamic"
            },
            "allowedValues": [
                "Static",
                "Dynamic"
              ]
            },
            "publicIpSku": {
                "defaultValue": "Standard",
                "type": "string",
                "metadata": {
                    "description": "Specify the SKU of the public IP address"
                },
                "allowedValues": [
                    "Standard",
                    "Basic"
                ]
            },
            "privateIpAllocationType": {
                "defaultValue": "Static",
                "type": "string",
                "metadata": {
                    "description": "Specify whether the private IP should be Static or Dynamic"
                },
                "allowedValues": [
                    "Static",
                    "Dynamic"
                ]
            },
            "privateIpAddress": {
                "defaultValue": "None",
                "type": "string",
                "metadata": {
                    "description": "A static private IP address to be used"
                }
            },
            "boolEnableAcceleratedNetworking": {
              "defaultValue": false,
              "type": "bool",
              "metadata": {
                  "description": "Specify whether the NIC should have Accelerated Networking enabled"
              }
            },
            "boolAttachNetworkSecurityGroup": {
              "defaultValue": false,
              "type": "bool",
              "metadata": {
                  "description": "Specify whether the NIC should have an NSG attached"
              }
            },
            "networkSecurityGroup": {
              "type": "string",
              "metadata": {
                  "description": "Name of an NSG to attach to the NIC"
              }
            },
            "boolJoinLoadBalancer": {
            "defaultValue": false,
            "type": "bool",
            "metadata": {
                "description": "Whether the NIC should belong to a Load Balancer Backend Pool. Default is false"
            }
          },
          "loadBalancerName": {
              "type": "string",
              "metadata": {
                  "description": "Name of an Azure Load Balancer to attach to the NIC"
              }
          },
          "loadBalancerBackendPoolName": {
            "type": "string",
            "metadata": {
                "description": "Name of the Backend Pool of the Load Balancer to join"
            }
          },
          "platform": {
              "allowedValues": [
                  "Windows",
                  "Linux"
              ],
              "type": "string",
              "metadata": {
                  "description": "Select the OS type to be provisioned"
              }
          },
          "boolUseHybridUseBenefit": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "Whether this server should use Hybrid Use Benefit licencing. Default is false"
              }
          },
          "timeZone": {
            "type": "string",
            "defaultValue": "AUS Eastern Standard Time",
            "metadata": {
                "description": "Timezone to use for this server. Default is AUS Eastern Standard Time"
            }
          },
          "adminUsername": {
            "type": "string",
            "metadata": {
                "description": "Specify the username of the Administrator account"
            }
        },
        "authenticationType": {
            "defaultValue": "Password",
            "allowedValues": [
                "Password",
                "SSH-Public-Key"
            ],
            "type": "string",
            "metadata": {
                "description": "Authentication type for the deployment"
            }
        },
        "adminPasswordOrKey": {
            "type": "SecureString",
            "metadata": {
                "description": "OS Admin password or SSH Key depending on value of authentication type"
            }
        },
        "virtualNetworkName": {
            "type": "string",
            "metadata": {
                "group": "Network Configuration",
                "description": "Name of the Virtual Network"
            }
        },
        "virtualNetworkRGName": {
            "type": "string",
            "metadata": {
                "group": "Network Configuration",
                "description": "Specify the name of the Resource Group where the vNet resides"
            }
        },
        "subnetName": {
            "type": "string",
            "metadata": {
                "group": "Network Configuration",
                "description": "Specify the name of the Subnet"
            }
        },
        "bootDiagnosticsStorage": {
          "type": "string",
          "metadata": {
            "group": "Infrastructure Configuration",
            "description": "Storage Account for storing boot diagnostics data"
          }
        },
        "boolBackupRequired": {
          "type": "bool",
          "defaultValue": false,
          "metadata": {
              "description": "Whether this server should be added to a Recovery Services Vault for Azure backup"
            }
        },
        "vaultName": {
          "type": "string",
          "metadata": {
            "description": "The Recovery Services Vault to which this server should be joined"
          }
        },
        "vaultResourceGroup": {
          "type": "string",
          "metadata": {
            "description": "The Resource Group containing the Recovery Services Vault to which this server should be joined"
          }
        },
        "backupPolicyName": {
          "type": "string",
          "metadata": {
            "description": "The Backup Policy that should be applied to this server"
          }
        },
        "boolUseDomainJoinExtension": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "Whether this server should be domain joined"
              }
          },
          "domainToJoin": {
            "type": "string",
            "metadata": {
              "description": "The domain to which this server should be joined"
            }
          },
          "ouPath": {
            "type": "string",
            "metadata": {
              "description": "The Organisational Unit into which server should be placed in the chosen domain"
            }
          },
          "domainJoinAccount": {
            "type": "string",
            "metadata": {
              "description": "The domain account to use for joining the domain"
            }
          },
          "domainJoinAccountPassword": {
            "type": "string",
            "metadata": {
              "description": "The domain account password for domain join"
            }
          },
          "boolUseDSCExtension": {
            "type": "bool",
            "defaultValue": true,
            "metadata": {
                "description": "Whether this server should use PowerShell DSC Extension"
              }
          },
          "dscExtensionUpdateTagVersion": {
            "type": "string",
            "metadata": {
              "description": "The current extension revision number. Increment by one with each update to ensure targets refresh their DSC settings"
            }
          },
          "dscFunction": {
            "type": "string",
            "metadata": {
                "description": "Calls function to execute within DSC configuration file"
            }
          },
          "_artifactsLocationSasToken": {
            "type": "string",
            "metadata": {
              "description": "SAS token for access to the DSC extension file"
            }
          },
          "_artifactsLocation": {
            "type": "string",
            "metadata": {
              "description": "URI of DSC artifacts required"
            }
          },
          "storageUserName": {
            "type": "string",
            "metadata": {
              "description": "The storage account where the DSC related tools downloads are saved for this environment"
            }
          },
          "storagePassword": {
            "type": "string",
            "metadata": {
              "description": "The access key for the storage account where the DSC related tools downloads are saved for this environment"
            }
          },
          "localAccountUserName": {
            "type": "string",
            "metadata": {
              "description": "Name of additional local user account to be added to local Administrators Group"
            }
          },
          "localAccountUserPassword": {
            "type": "securestring",
            "metadata": {
              "description": "Password of additional local user account to be added to local Administrators Group"
            }
          },
          "branch": {
            "type": "string",
            "defaultValue": "master",
            "metadata": {
              "description": "Code branch for template testing. Remove for master merge"
            }
          },
          "tagCostCentre": {
            "type": "string",
            "metadata": {
                "group": "Tags",
                "description": "Tag - Cost Cnetre"
            }
          },
          "tagApplication": {
            "type": "string",
            "metadata": {
                "group": "Tags",
                "description": "Tag - Application"
            }
          },
          "tagITOwner": {
            "type": "string",
            "metadata": {
                "group": "Tags",
                "description": "Tag - IT Owner"
            }
          },
          "tagProvisionedBy": {
            "type": "string",
            "metadata": {
              "description": "Tag - Provisioned By"
            }
          },
          "tagProvisionDate": {
            "type": "string",
            "metadata": {
              "description": "Tag - Provision Date"
            }
          },
          "tagEnvironment": {
            "type": "string",
            "allowedValues": [
                "Production",
                "Development",
                "Test"
            ],
            "metadata": {
                "group": "Infrastructure Configuration",
                "description": "Specify the environment which best describes the deployment."
            }
        }
    },
    "variables": {
        "networkApiVersion": "2018-07-01",
        "computeApiVersion": "2018-04-01",
        "extensionApiVersion": "2015-06-15",
        "vaultApiVersion": "2016-06-01",
        "deploymentApiVersion": "2015-01-01",
        "nestedDeploymentApiVersion": "2017-05-10",
        "mainResourceGroup": "[resourceGroup().name]",
        "templateLinkProd": "https://raw.githubusercontent.com/jvta/AzureVM/master",
        "templateLink": "[concat('https://raw.githubusercontent.com/jvta/AzureVM/',parameters('branch'))]",
        "nicName": "[concat(parameters('vmName'),'-nic1')]",
        "pipName": "[concat(parameters('vmName'),'-PIP')]",
        "backupFabric": "Azure",
        "protectionContainer": "[concat('iaasvmcontainer;iaasvmcontainerv2;', resourceGroup().name, ';', parameters('vmName'))]",
        "protectedItem": "[concat('vm;iaasvmcontainerv2;', resourceGroup().name, ';', parameters('vmName'))]",
        "emptyString": "",
        "tags": {
            "CostCentre": "[parameters('tagCostCentre')]",
            "Application": "[parameters('tagApplication')]",
            "ITOwner": "[parameters('tagITOwner')]",
            "provisionedBy": "[parameters('tagProvisionedBy')]",
            "provisionDate": "[parameters('tagProvisionDate')]",
            "Environment": "[parameters('tagEnvironment')]"
        }
    },
    "resources": [
        {
            "condition": "[and(parameters('boolAvSetCreateNew'),parameters('boolAvSetRequired'))]",
            "type":"Microsoft.Resources/deployments",
            "name":"provisionAvSet",
            "apiVersion":"[variables('deploymentApiVersion')]",
            "dependsOn":[],
            "properties":{
                "mode":"Incremental",
                "templateLink":{
                    "uri": "[concat(variables('templateLink'),'/','LinkedTemplates/provisionAVSet.json')]",
                    "contentVersion":"1.0.0.0"
                },
                "parameters":{
                    "location": {
                        "value": "[parameters('location')]"
                      },
                    "apiVersion":{
                        "value":"[variables('computeApiVersion')]"
                    },
                    "name":{
                        "value":"[parameters('avSetName')]"
                    },
                    "tags": {
                        "value": "[variables('tags')]"
                    }
                }
            }
        },
        {
            "condition": "[equals(parameters('networkPrivateOrPublic'),'Public')]",
            "type":"Microsoft.Resources/deployments",
            "name":"provisionPublicIp",
            "apiVersion":"[variables('deploymentApiVersion')]",
            "dependsOn":[],
            "properties":{
                "mode":"Incremental",
                "templateLink":{
                    "uri": "[concat(variables('templateLink'),'/','LinkedTemplates/provisionPIP.json')]",
                    "contentVersion":"1.0.0.0"
                },
                "parameters":{
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "apiVersion":{
                        "value":"[variables('networkApiVersion')]"
                    },
                    "name":{
                        "value":"[variables('pipName')]"
                    },
                    "publicIpAllocationType":{
                        "value":"[parameters('publicIpAllocationType')]"
                    },
                    "sku": {
                        "value": "[parameters('publicIpSku')]"
                    },
                    "tags": {
                        "value": "[variables('tags')]"
                    }
                }
            }
        },
        {
            "name": "provisionNetworkInterface",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('deploymentApiVersion')]",
            "dependsOn":[
              "Microsoft.Resources/deployments/provisionPublicIp"
            ],
            "properties": {
              "mode": "Incremental",
              "templateLink": {
                "uri": "[concat(variables('templateLink'),'/LinkedTemplates/','provisionNIC',parameters('networkPrivateOrPublic'),'.json')]",
                "contentVersion": "1.0.0.0"
              },
              "parameters": {
                "location": {
                  "value": "[parameters('location')]"
                },
                "tags": {
                    "value":"[variables('tags')]"
                },
                "pipId": {
                    "value": "[if(equals(parameters('networkPrivateOrPublic'),'Public'), reference('provisionPublicIp').outputs.resourceID.value, 'None')]"
                },
                "nicName": {
                  "value": "[variables('nicName')]"
                },
                "networkApiVersion": {
                    "value": "[variables('networkApiVersion')]"
                  },
                "virtualNetworkName": {
                  "value": "[parameters('virtualNetworkName')]"
                },
                "virtualNetworkRGName": {
                  "value": "[parameters('virtualNetworkRGName')]"
                },
                "subnetName": {
                  "value": "[parameters('subnetName')]"
                },
                "privateIpAddress": {
                    "value": "[parameters('privateIpAddress')]"
                },
                "privateIpAllocationType": {
                  "value": "[parameters('privateIpAllocationType')]"
                },
                "boolEnableAcceleratedNetworking": {
                  "value": "[parameters('boolEnableAcceleratedNetworking')]"
                },
                "boolAttachNetworkSecurityGroup": {
                  "value": "[parameters('boolAttachNetworkSecurityGroup')]"
                },
                "networkSecurityGroup": {
                  "value": "[parameters('networkSecurityGroup')]"
                },
                "boolJoinLoadBalancer": {
                  "value": "[parameters('boolJoinLoadBalancer')]"
                },
                "loadBalancerName": {
                  "value": "[parameters('loadBalancerName')]"
                },
                "loadBalancerBackendPoolName": {
                  "value": "[parameters('loadBalancerBackendPoolName')]"
                }
              }
            }
          },
          {
            "name": "provisionCompute",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('deploymentApiVersion')]",
            "dependsOn": [
                "Microsoft.Resources/deployments/ProvisionNetworkInterface",
                "Microsoft.Resources/deployments/ProvisionAvSet"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('templateLink'),'/LinkedTemplates/provisionVM',if(equals(length(parameters('dataDisks')),0),'NoDataDisks','WithDataDisks'),'.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "vmName": {
                        "value": "[parameters('vmName')]"
                    },
                    "vmSize": {
                        "value": "[parameters('vmSize')]"
                    },
                    "tags": {
                        "value":"[variables('tags')]"
                    },
                    "nicName": {
                        "value": "[variables('nicName')]"
                    },
                    "computeApiVersion": {
                        "value": "[variables('computeApiVersion')]"
                    },
                    "extensionApiVersion": {
                        "value": "[variables('extensionApiVersion')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "boolAvSetRequired": {
                      "value": "[parameters('boolAvSetRequired')]"
                    },
                    "avSetName": {
                        "value": "[if(parameters('boolAvSetRequired'), parameters('avSetName'), variables('emptyString'))]"
                    },
                    "vmOsDiskSize": {
                        "value": "[parameters('vmOsDiskSize')]"
                    },
                    "osDiskStorageType": {
                        "value": "[parameters('osDiskStorageType')]"
                    },
                    "dataDisks": {
                      "value": "[parameters('dataDisks')]"
                    },
                    "platform": {
                      "value": "[parameters('platform')]"
                    },
                    "timeZone": {
                      "value": "[parameters('timeZone')]"
                    },
                    "boolUseHybridUseBenefit": {
                      "value": "[parameters('boolUseHybridUseBenefit')]"
                    },
                    "authenticationType": {
                      "value": "[parameters('authenticationType')]"
                    },
                    "adminPasswordOrKey": {
                      "value": "[parameters('adminPasswordOrKey')]"
                    },
                    "bootDiagnosticsStorage": {
                      "value": "[parameters('bootDiagnosticsStorage')]"
                    },
                    "boolUseDomainJoinExtension": {
                      "value": "[parameters('boolUseDomainJoinExtension')]"
                    },
                    "domainToJoin": {
                      "value": "[parameters('domainToJoin')]"
                    },
                    "ouPath": {
                      "value": "[parameters('ouPath')]"
                    },
                    "domainJoinAccount": {
                      "value": "[parameters('domainJoinAccount')]"
                    },
                    "domainJoinAccountPassword": {
                      "value": "[parameters('domainJoinAccountPassword')]"
                    },
                    "boolUseDSCExtension": {
                      "value": "[parameters('boolUseDSCExtension')]"
                    },
                    "dscExtensionUpdateTagVersion": {
                      "value": "[parameters('dscExtensionUpdateTagVersion')]"
                    },
                    "dscFunction": {
                      "value": "[parameters('dscFunction')]"
                    },
                    "_artifactsLocationSasToken": {
                      "value": "[parameters('_artifactsLocationSasToken')]"
                    },
                    "_artifactsLocation": {
                      "value": "[parameters('_artifactsLocation')]"
                    },
                    "storageUserName": {
                      "value": "[parameters('storageUserName')]"
                    },
                    "storagePassword": {
                      "value": "[parameters('storagePassword')]"
                    },
                    "localAccountUserName": {
                      "value": "[parameters('localAccountUserName')]"
                    },
                    "localAccountUserPassword": {
                      "value": "[parameters('localAccountUserPassword')]"
                    }
              }
            }
        },
        {
          "condition": "[equals(parameters('boolBackupRequired'),'true')]",
          "name": "nestedBackupDeployment",
          "apiVersion": "[variables('nestedDeploymentApiVersion')]",
          "type": "Microsoft.Resources/deployments",
          "dependsOn": [
            "Microsoft.Resources/deployments/provisionCompute"
          ],
          "resourceGroup": "[parameters('vaultResourceGroup')]",
          "properties": {
            "mode": "incremental",
            "template": {
              "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
              "contentVersion": "1.0.0.0",
              "parameters": {},
              "variables": {},
              "resources": [
                {
                  "type": "Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems",
                  "name": "[concat(parameters('vaultName'), '/', variables('backupFabric'), '/', variables('protectionContainer'), '/', variables('protectedItem'))]",
                  "apiVersion": "[variables('vaultApiVersion')]",
                  "location": "[parameters('location')]",
                  "properties": {
                    "protectedItemType": "Microsoft.Compute/virtualMachines",
                    "policyId": "[resourceId('Microsoft.RecoveryServices/vaults/backupPolicies', parameters('vaultName'), parameters('backupPolicyName'))]",
                    "sourceResourceId": "[resourceId(variables('mainResourceGroup'),'Microsoft.Compute/virtualMachines/', parameters('vmName'))]"
                  }
                }
              ]
            }
          }
      }
    ],
    "outputs": {}
}
